<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0">
    <meta name="description" content="Tizen basic template generated by Tizen Web IDE"/>
    <title>客服管理后台</title>
    <link rel="stylesheet" type="text/css" href="css/pay.css"/>
</head>
<body>
<div class="top-bar">
   <div class="wrapper">
      <div class="logo"></div>
      <div class="nav">
         <a href="#" class="first">大家关注</a>
         <a href="#">客户服务</a>
      </div>
      <div class="buy-btn">立即购买</div>
   </div>
</div>
<div class="pay-box">
    <div class="pay-hd">
        <div class="last-time">支付剩余时间 29：59</div>
        <h2 class="tl">请选择购买方式</h2>
    </div>
    <div class="pay-bd">
        <div class="pay-item amazon-item">
            <div class="amazon-tl item-hd">购买方式一：亚马逊购买</div>
            <div class="amazon-bd item-bd">
                <div class="amazon-icon  item-icon"></div>
                <div class="amazon-pay item-pay">
                    <a href="http://www.amazon.com/Suntv3-Quad-core-Chinese-StreamingCertified/dp/B015EQO1KY/ref=sr_1_1?ie=UTF8&qid=1444351778&sr=8-1&keywords=gwsun" class="amazon-btn">亚马逊购买</a>
                    <div class="amazon-info item-info">
                        转到亚马逊官方网店购买产品<br>订单价格为：<span class="amazonPrice">188$</span>
                    </div>
                </div>
            </div>
        </div>
        <div class="pay-item weixin-item">
            <div class="weixin-tl item-hd">购买方式二：微信购买</div>
            <div class="weixin-bd item-bd">
                <div class="weixin-icon  item-icon"></div>
                <div class="weixin-pay item-pay">
                    <div class="weixin-qrcode item-qrcode">
                        <img src="images/pay/qrcode.jpg">
                    </div>
                    <div class="weixin-info item-info">
                        使用微信“扫一扫”扫描此二维码购买产品<br>订单价格为：<span class="weixinPrice">188$</span>
                    </div>
                </div>
            </div>
        </div>
        <div class="pay-item zhifubao-item">
            <div class="zhifubao-tl item-hd">购买方式三：支付宝购买</div>
            <div class="zhifubao-bd item-bd">
                <div class="zhifubao-icon  item-icon"></div>
                <div class="zhifubao-pay item-pay">
                    <div class="zhifubao-qrcode item-qrcode">
                        <img src="images/pay/qrcode.jpg">
                    </div>
                    <div class="zhifubao-info item-info">
                        使用支付宝“扫一扫”扫描此二维码购买产品<br>订单价格为：<span class="zhifubaoPrice">188$</span>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
<div class="pay"></div>
<script src="js/jquery.min.js"></script>
<script src="js/bootstrap.min.js"></script>
<script type="text/javascript" src="js/jquery.cookie.js"></script>
<script type="text/javascript" src="js/socket.io.js"></script>
<script type="text/javascript">
   var saleschat;
   var cid,nickname;
   var $chatTextArea = $("#chatTextArea");
   var $submit = $("#submitBtn");
   var $chatList = $("#chatList");
   var $tipCustomer = $("#tipCustomer");
   var ctrl = false;
   $(document).ready(function () {
      /*getCid();
      socketIO();
      listen();
      statistics();*/
   });
   function listen(){
      $(window).keydown(function(event){
         switch(event.keyCode) {
            case 13:
               if(ctrl){
                  ctrl = false;
                  speak();
               }
               break;
            case 17:
               ctrl = true;
               break;
            default :
               console.info(event.keyCode);
               break;
         }
      });
      $chatTextArea.keyup(function(){
         ctrl = false;
      });
      $submit.on("click", function () {
         speak();
      })
   }
   function statistics(){
      var referrer = "";
      var data = {};
      if (document.referrer.length > 0) {
         referrer = document.referrer;
      } else {
         if (opener.location.href.length > 0) {
            referrer = opener.location.href;
         }
      }
      data.referrer = referrer;
      console.info(data);
      $.ajax({
         url:"http://221.228.74.40/saleschat/api/admin/track",
         data:data,
         error: function () {
            console.info("请求出错！")
         },
         success: function (o) {
            console.info(o);
         }
      })
   }
   function speak(){
      var txt = $chatTextArea.val();
      var html = '';
      if(txt != ""){
         console.info("{code: 'speak', cnt: " + txt + ", style:''}");
         saleschat.send({code: 'speak', cnt: txt, style:""});
         html += '<div class="txt1"><p class="desc">我：</p><p class="time">' + timeUTCFormat() + '</p><p class="que">' + txt + '</p></div>';
         //html += '<li><div class="msg"><h2 class="msg-from">我<span class="release-time">' + timeUTCFormat() + '</span></h2><p class="msg-cnt">' + txt + '</p></div></li>';
         $chatList.append(html);
         $chatTextArea.val("");
      }
   }
   function wellcome() {
      var html = '<div class="txt1"><p class="desc1">客服：</p><p class="time">' + timeUTCFormat() + '</p><p class="que">您好，欢迎光临！请问有什么可以帮到您的？</p></div>';
      //var html = '<li><div class="come-msg msg"><h2 class="msg-from">客服<span class="release-time">' + timeUTCFormat() + '</span></h2><p class="msg-cnt">您好，欢迎光临！请问有什么可以帮到您的？</p></div></li>';
      $chatList.html(html);
   }
   function comeSpeak(data){
      var html = '';
      html += '<div class="txt1"><p class="desc1">' + data.nickname + '：</p><p class="time">' + timeUTCFormat(data.tm) + '</p><p class="que">' + data.cnt + '</p></div>';
      //html += '<li><div class="come-msg msg"><h2 class="msg-from">' + data.nickname + '<span class="release-time">' + timeUTCFormat(data.tm) + '</span></h2><p class="msg-cnt">' + data.cnt + '</p></div></li>';
      $chatList.append(html);
   }
   function timeUTCFormat(time){
      var date;
      if(time == undefined || time == ""){
         date = new Date();
      } else {
         date = new Date(parseInt(time));
      }
      var h = date.getHours ();
      h = h ? (h >= 10 ? h : "0" + h) + ":" : "00:";
      var m = date.getMinutes ();
      m = m ? (m >= 10 ? m : "0" + m ) : "00";
      return h + m;
   }
   function getCid(){
      cid = $.cookie("customer_cid");
      if(cid == undefined){
         var time = new Date().getTime();
         cid = "RDID_" + time;
         $.cookie("customer_cid",cid,{expires:365,path:"/"});
      }
      nickname = "客户" + cid.slice(14,18);
      $tipCustomer.text(nickname);
   }
   function socketIO(){
      saleschat = io.connect('http://221.228.74.40', {
         reconnection: true,
         reconnectionDelay: 1000,
         reconnectionDelayMax: 3000,
         timeout: 1000,
         mutiplex: false,
         path: '/saleschat/socket.io'
      });
      saleschat.on('connect', function () {
         console.info('client is connected successfully');
         //Step N.5 必须进行CheckIn注册
         console.info("{cid: " + cid + ", code: 'checkIn', nickname: " + nickname + "}");
         saleschat.send ({cid: cid, code: 'checkIn', nickname: nickname});
         wellcome();
      });
      //消息通道其他消息处理
      saleschat.on('reconnect', function (trynum) {
         console.info('client is trying to reconnect,NO.' + trynum);
      });
      saleschat.on('disconnect', function () {
         console.info('client is disconnected exceptionally');
      });
      saleschat.on('error', function (err) {
         console.info('client errors', err);
      });
      saleschat.on ('message', function(msg) {
         switch (msg.code) {
            case 'checkIn_ok':
               //用户CheckIn注册成功
               console.log(msg.code);
               saleschat.send({code: 'history'});
               break;
            case 'speak_ok':
               //用户发音反馈成功
               console.log(msg.code);
               break;
            case 'speak':
               //用户发音反馈成功
               console.log(msg.code,"来消息");
               comeSpeak(msg);
               break;
            case 'broadcast':
               //用户发音反馈成功 群内有人说话广播消息
               break;
            case 'history_ok':
               console.log(msg.code);
               break;
            case 'delspeak':
               //有一条消息被删除
               console.log(msg.code);
               break;
            case 'error':
               //消息异常错误
               console.log(msg.code);
               break;
            default :
               console.log(msg);
               break;
         }
      });
   }
</script>
</body>
</html>